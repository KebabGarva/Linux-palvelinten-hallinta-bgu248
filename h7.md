# WORK IN PROGRESS: Salt module to make it easy for Linux beginners to setup Fedora 40 with working Nvidia drivers + SecureBoot on _by Saku Laitinen_

## List of contents and short introduction

- **[How to install salt-minion and copy the module to make the commands work](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#how-to-install-salt-minion-and-copy-the-module-to-make-the-commands-work)**
  
  - **[Step 1: Install the salt-minion](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#step-1-install-the-salt-minion)**
    
  - **[Step 2: Make the states work](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#step-2-make-the-states-work)**
    
  - **[Step 3: Test if the module works](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#step-3-test-if-the-module-works)**


- **[How to use the module step-by-step](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#how-to-use-the-module-step-by-step)**

  - **[Step 1: Initial Setup](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#step-1)**
    
  - **[Step 2: Adding repos and reboot](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#step-2)**
    
  - **[Step 3: Generating and importing key](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#step-3)**
    
  - **[Step 4: Installing Nvidia drivers](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#step-4)**
    
  - **[Step 5: Check that the built modules run kernel & boot image status](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#step-5)**
    
  - **[(OPTIONAL) Step 6: Install user-experience enhancing programs](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#step-6)**

- **[Quick summary to what the module actually does](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h7.md#quick-summary-to-what-the-module-actually-does)**

This is a module that is heavily inspired by roworu's guide to install Nvidia drivers that work with SecureBoot on. If you want to star this module, please show some love for them by [starring their guide](https://github.com/roworu/nvidia-fedora-secureboot)!

The module was done as the final work for [Tero Karvinen's Saltstack course](https://terokarvinen.com/2024/configuration-management-2024-spring/). The module was finalized on May 12 2024. This readme will be transferred to the right repository (the repo where the module is) in the future. The point of this module is to show that Salt can be used as a fault-proof way to automatize individual configuration much better than bash scripts.

If you're a beginner to Linux and you want to make your games run smoothly, you've come to the right place! Follow these steps to get started!

## How to install salt-minion and copy the module to make the commands work

**NOTE: If you want to get to know Salt and about its operation, click [this link](https://docs.saltproject.io/en/latest/topics/index.html) to see introduction to Salt.**

Feel free to copy-paste these commands, because I explain what these commands do.

And for you, absolute Linux beginners, you use `sudo` when you need to run commands with administrator privileges. 

### Step 1: Install the salt-minion

This installs the salt using Fedora's default package manager dnf. The option "-y" means that it automatically accepts the installation without having to press the y button manually.

```
sudo dnf install -y salt-minion
```
### Step 2: Make the states work

First command makes sure that your user is in their home directory. The second command clones my repository using git, which is hands-down the best version manager software and installed ready with your Fedora 40. The third command makes a new directory with "-p" option that will create the directory regardless if directory `/srv/` doesn't exist yet. The fourth command copies the cloned repository to the salt-directory. The "-r" option means that the command copies the directory recursively.

```
cd
```
```
git clone
```
```
sudo mkdir -p /srv/salt
```
```
sudo cp -r salt-nvidia-secureboot/* /srv/salt/
```

### Step 3: Test if the module works

Run this following command to make sure that the module works as intended. The specified state makes a `helloworld.txt` file in `/home/` folder. If the file is there, you're good to go. Salt will let you know if the file has been made, if it already exists or the module doesn't work.

```
sudo salt-call --local -l info state.apply hello
```
This is what should happen if you've followed :

![image](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/assets/89390996/e44da40d-db81-41d9-b4d4-7b74246c25c8)

## How to use the module step-by-step

***FIRST NOTE: If you have tried manually installing NVIDIA drivers e.g. from their website ([example website](https://www.nvidia.com/Download/index.aspx)) and running the installation file... STOP NOW!! Back up your most valuable data before installing Fedora 40 again***

***SECOND NOTE: Don't forget to add the step after state.apply, because***

### Step 1

Run the following command in the terminal:

```
sudo salt-call --local -l info state.apply step1
```

This will delete all older Nvidia packages that could potentially conflict with the setup process. This will also make sure if SecureBoot is on and 

Scroll up in the terminal or press `CTRL+SHIFT+F` to search "SecureBoot". The easiest way to read the info is under `stdout:`. This is where salt prints `cmd.run` -function's output. You'll need this info later on to help you to find the outputs later on.

Copy-paste this command to make sure that you have no enrolled keys in MOK.

```
sudo mokutil --delete /etc/pki/akmods/certs/public_key.der
```

If you don't have any keys, good!! Reboot anyway to make sure that the packages are compeletely gone:

```
sudo systemctl reboot
```

If you have enrolled keys, you'll be asked to input your password. If you don't remember the password, feel free to try a few times. If it seems hopeless, don't worry! Installing Fedora 40 again will not take too long, and you can make a new partition where you can move your important files or just back-up them in the cloud. ðŸ«¶ðŸ«¶ðŸ«¶

If you need to delete the key, copy paste the contents in the first box and follow the instructions below:

```
sudo systemctl reboot
```
Select Enroll Mok -> Select Continue -> type your password -> Reboot or Continue boot

After you've done that proceed to the next step

### Step 2

```
sudo salt-call --local -l info state.apply step2
```

This will add the rpmfusion repos and update the system. Copy-paste the command and run it in the terminal

After you've successfully run the command, reboot the system again.

```
sudo systemctl reboot
```

### Step 3

```
sudo salt-call --local -l info state.apply step3
```

This will install signing modules, generate a key and import the key. BEFORE you run the command, you can set your own password if you want. The default password is `1234wohoo`. If you want to change the password, you can edit the `init.sls` -file. 

```
sudoedit /srv/salt/step3/init.sls
```

The command `printf '1234wohoo\n1234wohoo\n'` is the one in the question. Don't remove any one of the two `\n` newlines because they act as ENTER -keys! The command will not work then! Be careful!

After successfully running step 3 command, reboot the system

```
sudo systemctl reboot
```
After this, you are inside MOK manager. Follow the instructions below:

Select Enroll Mok -> Select Continue -> type your password -> Reboot or Continue boot

After this, you're ready to install NVIDIA drivers

### Step 4

```
sudo salt-call --local -l info state.apply step4
```
This will install Nvidia drivers.

If you want to install CUDA support to your CUDA-compatible GPU, copy-paste the command below:

```
sudo dnf -y install xorg-x11-drv-nvidia-cuda
```

**NOW WAIT!!** The modules take some time to load. I recommend waiting at least 5 minutes and 10 minutes is recommended. You can check if the process is done by checking if terminal returns the driver version. If it prints something else, **HOLD STILL! THE MODULES ARE STILL BUILDING!**

You're good to go, if it prints something like this:

![image](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/assets/89390996/cb2853ce-979c-40e4-abfb-95823131bd19)


## Step 5

```
sudo salt-call --local -l info state.apply step5
```
This will check akmods packages and will build them if needed. It will also overwrite the existing initramfs file.

After this is done, reboot again and you can enjoy your new working drivers!

```
sudo systemctl reboot
```
Remember to select "Gnome on Xorg", because Wayland doesn't simply work as intended with Nvidia GPU's. 

If you want to make sure if your setup worked, type the command below:

```
nvidia-smi
```

This will return driver info if driver has installed properly.

Next I'll include an optional step to install not mandatory, but **SUPER USEFUL APPS** to enhance your Linux experience.

## Step 6

This will not use Salt, but I wanted to include this step so you can take a look at the Software app for something nice to download.

Here are my recommendations:

 - Vesktop
   - Discord client that actually works
 - Gnome Extension manager
   - get to customize your desktop enviroment to look exactly how you want it
   - Check [this Youtube video](https://www.youtube.com/watch?v=AE1-W2bMVEs) to help you pick extensions.
 - Steam
 - ProtonUp-Qt GUI to install Wine- and Proton-based compability tools
 - Lutris universal game launcher
 - Mangohud overlay for monitoring FPS
 - Goverlay GUI to customize the Mangohud config file

## Quick summary to what the module actually does

This is to explain to my lecturer and peer students how the module works in a nutshell.

### Initial setup

- Make sure that SecureBoot is on
  - If it's not on, the user turns it on via BIOS settings.
- All older Nvidia installations have been uninstalled
- Reboot

### Adding repos and reboot

- Adding rpmfusion repos
  - free
  - nonfree
- Full update of system
- Reboot

### Generating and importing key

- Generating the key
- Importing the key
  - Uses the pre-determined password that is highly recommended to modify to your own needs.
- Reboot
  - After reboot, user enrolls the key in MOK manager

### Installing Nvidia drivers 

- Uses pkg.installed state function to install the packages
- Waiting period of 5-10 minutes because the modules need to build before rebooting

### Check that the built modules run kernel & boot image status

- Run akmods and dracut by force
- Reboot

Remember to ***CHOOSE GNOME ON XORG*** in the lock screen settings that is located in the ***right-bottom corner***.

## Why Fedora 40 and not Nobara.

### TL;DR

Use this module if you think Nobara isn't for you but you still want to have the option to play games on Linux with SecureBoot on without stressful tinkering for a long time. 

#### Longer explanation

Even though Nobara makes it easy to setup Linux for gaming without any tinkering, the reasons are very self-explanatory at least for me:

- ***SecureBoot needs to be turned OFF for Nobara***
- Nobara is directed heavily towards people who just want to use the distro for gaming only
  - Not an universal solution for everyone
  - "Too gamer-distro for regular user"
- Fedora 40 is more
  - secure
  - supported
  - **universally faster**

The point of the module is to automatically make sure that all preconditions for setuping Fedora properly for gaming have been met and then doing all necessary installations and commands.
This will save beginners a lot of time and from massive headaches.

## Testing the module

This is to make sure that the module works following my instructions. I started from Fresh install of Fedora 40. I made a seperate partition to test my modules natively to make it 100% clear that this works. This is a screenshot as a proof that I started from a fresh install of Fedora 40.



