# Demoni *by Saku Laitinen*

## Sisällysluettelo

- **[Johdanto](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h3.md#Johdanto)**
- **[Lämmittelytehtävä](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/blob/main/h3.md#Lämmittelytehtävä)**


## Johdanto

### Mitä?

Tämä raportti on tehty Tero Karvisen toteuttaman kurssin [Palvelinten hallinta](https://terokarvinen.com/2024/configuration-management-2024-spring/) yhteydessä. Tämä raportti kertoo läpikohtaisesti, mitä tein tehtävän **h4** eteen. Sisällysluettelon linkkejä painamalla pystyy navigoimaan suoraan haluttuun kohtaan.

### Missä?

Toteutin tehtäviin liittyvät komennot fyysisessä Windows 11 - ja virtuaalisissa  Spesifoin tarkemmin kappaleen alussa, mitkä ovat käytettävän/käytettävien käyttöjärjestelmien tiedot. Kaikki Windowsilla tehdyt komennot on tehty fyysisessä ympäristössä, ja Linuxilla on tehty virtuaaliympäristössä. 

**Tietokoneet**

- [*Fyysinen kone: Lenovo Legion 7 16ACHg6*](https://nanoreview.net/en/laptop/lenovo-legion-7-2021-amd?m=c.1_g.3_r.3_s.3)
- [*Vagrant: debian/bullseye64*](https://app.vagrantup.com/debian/boxes/bullseye64)

### Milloin?

Testit ja oikoluku tehtiin 21.4.

## Lämmittelytehtävä

<details>

<summary>a)</summary>

### Infraa koodina

- Saltilla hallinoidaan palvelimia init.sls -tiedostoilla.
  - Arkikielessä niillä tarkoitetaan tiloja, joita ajetaan orjakoneessa
  - Kyseisissä tiedostoissa noudatetaan YAML -syntaxia
  - Toimii kuin skripti, joka komennetaan orjalle/orjille toteutettavaksi
- Esimerkkitila:

```
/home/vagrant/hey-you-this-is-an-example.file:
  file.managed
```
  
- Tiedosto top.sls määrittää, mitä tiloja suoritetaan määritetyssä orjassa.
- Esimerkki top.sls -tiedostosta
  ```
  base:
    '*':
      - hey-you-this-is-an-example-state
  ```

Karvinen, Tero: Salt Vagrant - automatically provision one master and two slaves. https://terokarvinen.com/2023/salt-vagrant/#infra-as-code---your-wishes-as-a-text-file
  
</details>

<details>

<summary>b)</summary>

### Mites sitä YAML:ia nyt käytettiin??

- YAML:n nyrkkisäännöt:
  - Älä käytä sarkainta vaan ***KAKSI VÄLILYÖNTIÄ***
  - Kirjainkoolla on merkitystä
  - `avain: arvo` -rakenne on koko homman ydin.
    - Seuraava vaihe tyypillisesti on `avain: arvo: -muuttuja`
  - Kommentointi onnistuu `#` -merkillä.
    - esim. #Nuorijavilli tai # Nuori ja villi (tietäjät tietää vai onks muistikuvioo lainkaa kovan juhlimisen jälkee)
   
Saltproject: Salt user guide: Salt overview. https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml
</details>

<details>

<summary>c)</summary>

### Pkg-file-service -esimerkkitoiminta

- Daemoneja voidaan luoda saltin kautta!
  - pkg-file-service -rakenne on koko toiminnan ydin
  - Lähteenä on herran oma sshd_config -tiedosto kotihakemistossa
- Esimerkki vahvasti lainattu, mutta muokattu artikkelista:

```
apache2:
 pkg.installed
/etc/ssh/apache2-config:
 file.managed:
   - source: salt://apache2-config
apache2.service:
 service.running:
   - watch:
     - file: /etc/ssh/apache2-config
```

</details>

**Pikainen Herra-orja arkkitehtuurin muodostaminen**

--------------------------------------------------------------------------------

VagrantFile:

```
# -*- mode: ruby -*-
# vi: set ft=ruby :
# Copyright 2024 Saku Laitinen https://github.com/KebabGarva/

$tscript = <<TSCRIPT
echo "running apt-get update aww yea"
apt-get update
echo "Okay, let's do this - https://github.com/KebabGarva/"
TSCRIPT

Vagrant.configure("2") do |config|
	config.vm.synced_folder ".", "/vagrant", disabled: true
	config.vm.synced_folder "shared/", "/home/vagrant/shared", create: true
	config.vm.provision "shell", inline: $tscript
    config.vm.box = "debian/bullseye64"

	config.vm.define "s001" do |s001|
		s001.vm.hostname = "s001"
		s001.vm.network "private_network", ip: "192.168.56.101"
	end

	config.vm.define "s002" do |s002|
		s002.vm.hostname = "s002"
		s002.vm.network "private_network", ip: "192.168.56.102"
		s002.vm.network "forwarded_port", guest: 80, host: 8080

	end
	
end
```

--------------------------------------------------------------------------------

Virtuaalikoneiden käynnistys, ja ohjelmistopakettien asennus:

```
vagrant up
vagrant ssh s001
sudo apt-get -y install salt-master
exit
vagrant ssh s002
sudo apt-get -y install salt-minion
```

![image](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/assets/89390996/1022e258-adbb-4197-8e0a-1ca5c6da43cc)

![image](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/assets/89390996/030f6da7-83b6-47ff-83c6-2064376354d5)

![image](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/assets/89390996/0806b01d-305a-4cc4-a4aa-6a0d3ec8952f)

----------------------------------------------------------------------------------------------------

Konfigurointi orjassa, ja yhteyden muodostaminen:

```
sudoedit /etc/salt/minion
master: 192.168.56.101
id: apache2
sudo systemctl restart salt-minion.service
exit
vagrant ssh s001
sudo salt-key -A
Y
```

![image](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/assets/89390996/e59bd6a7-bfb1-4022-a794-ad5d80f71348)

![image](https://github.com/KebabGarva/Linux-palvelinten-hallinta-bgu248/assets/89390996/3a86dce8-3d83-4195-97cc-0800572d6b3c)

-----------------------------------------------------------------------------------------------------

## Hello SLS-tila

Loin hakemiston kaikkia Salt-tiloja varten, latasin micron, ja loin ensimmäisen tilan pyöritettäväksi! En luonut vielä top.sls -tiedostoa.

```
mkdir -p /srv/salt/hello
micro /srv/salt/hello/init.sls
sudo salt '*' state.apply hello
```




